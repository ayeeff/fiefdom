<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global EEZ Viewer - Cesium.js</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000;
    }
    
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      z-index: 1000;
      text-align: center;
      background: rgba(0,0,0,0.8);
      padding: 30px;
      border-radius: 10px;
    }
    
    .loading-icon {
      font-size: 40px;
      margin-bottom: 10px;
      animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .info-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      background: rgba(0,0,0,0.8);
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 350px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .info-panel h2 {
      margin: 0 0 12px 0;
      font-size: 20px;
      font-weight: bold;
    }
    
    .info-panel p {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .info-panel .tips {
      margin: 10px 0 0 0;
      font-size: 12px;
      opacity: 0.8;
      line-height: 1.4;
    }
    
    .info-panel .source {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.2);
      font-size: 11px;
      opacity: 0.7;
    }

    .debug-info {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 11px;
      z-index: 1000;
      max-width: 300px;
    }
    
    .hidden {
      display: none;
    }

    .error {
      background: rgba(200, 0, 0, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1001;
      max-width: 400px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="loading-icon">üåç</div>
    <div>Loading Real EEZ Boundaries...</div>
    <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">
      This may take a moment
    </div>
  </div>
  
  <div class="info-panel">
    <h2>üåç Global EEZ Viewer</h2>
    <p>
      Displaying real Exclusive Economic Zone boundaries from official maritime data sources.
    </p>
    <p class="tips">
      üí° Hover over zones for country details<br>
      üîÑ Globe auto-rotates (pauses on interaction)<br>
      üñ±Ô∏è Click and drag to rotate manually
    </p>
    <div class="source">
      üìä Data: Marine Regions / Natural Earth<br>
      Powered by: Cesium.js
    </div>
  </div>
  
  <div id="cesiumContainer"></div>
  
  <div id="debug" class="debug-info hidden"></div>

  <script>
    // Color palette for different countries
    const countryColors = {};
    let colorIndex = 0;
    const colorPalette = [
      Cesium.Color.fromCssColorString('rgba(0, 85, 164, 0.5)'),    // Blue
      Cesium.Color.fromCssColorString('rgba(178, 34, 52, 0.5)'),   // Red
      Cesium.Color.fromCssColorString('rgba(0, 156, 59, 0.5)'),    // Green
      Cesium.Color.fromCssColorString('rgba(255, 153, 51, 0.5)'),  // Orange
      Cesium.Color.fromCssColorString('rgba(188, 0, 45, 0.5)'),    // Crimson
      Cesium.Color.fromCssColorString('rgba(0, 119, 73, 0.5)'),    // Emerald
      Cesium.Color.fromCssColorString('rgba(186, 12, 47, 0.5)'),   // Burgundy
      Cesium.Color.fromCssColorString('rgba(0, 0, 139, 0.5)'),     // Navy
      Cesium.Color.fromCssColorString('rgba(204, 0, 0, 0.5)'),     // Scarlet
      Cesium.Color.fromCssColorString('rgba(116, 172, 223, 0.5)'), // Sky Blue
    ];

    function getCountryColor(countryName) {
      if (!countryName) return Cesium.Color.GRAY.withAlpha(0.4);
      
      if (!countryColors[countryName]) {
        countryColors[countryName] = colorPalette[colorIndex % colorPalette.length];
        colorIndex++;
      }
      return countryColors[countryName];
    }

    // Initialize Cesium when page loads
    window.addEventListener('load', async function() {
      const container = document.getElementById('cesiumContainer');
      const loading = document.getElementById('loading');
      const debug = document.getElementById('debug');
      
      // Show debug info
      debug.classList.remove('hidden');
      debug.innerHTML = 'Initializing Cesium...';

      // Create Cesium viewer (terrain commented out as per user)
      const viewer = new Cesium.Viewer('cesiumContainer', {
        // terrain: Cesium.Terrain.fromWorldTerrain(),  // Commented out
        // Updated: Use createWorldImagery() for distinct land (green/brown) and ocean (blue) colors
        imageryProvider: Cesium.createWorldImagery({
          style: Cesium.IonWorldImageryStyle.AERIAL_WITH_LABELS  // High-contrast aerial view with clear land/ocean distinction
        }),
        baseLayerPicker: false,
        geocoder: false,
        homeButton: false,
        sceneModePicker: false,
        navigationHelpButton: false,
        animation: false,
        timeline: false,
        fullscreenButton: false,
        vrButton: false,
        requestRenderMode: true,  // Efficient rendering
        maximumRenderTimeChange: Infinity
      });

      // Set initial view
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(0, 0, 20000000)
      });

      // Auto-rotate with interaction pause
      let isInteracting = false;
      const rotationSpeed = Cesium.Math.toRadians(0.5);  // Adjust speed as needed
      const autoRotateInterval = setInterval(() => {
        if (!isInteracting && !viewer.selectedEntity) {
          viewer.scene.camera.rotate(Cesium.Cartesian3.UNIT_Z, rotationSpeed / 60);  // Slow rotation per frame
        }
      }, 16);  // ~60 FPS

      // Detect interactions to pause rotation
      const handler = viewer.screenSpaceEventHandler;
      handler.setInputAction(() => { isInteracting = true; }, Cesium.ScreenSpaceEventType.LEFT_DOWN);
      handler.setInputAction(() => { isInteracting = false; }, Cesium.ScreenSpaceEventType.LEFT_UP);
      handler.setInputAction((movement) => {
        if (movement.endPosition && !isInteracting) {
          isInteracting = true;
          setTimeout(() => { isInteracting = false; }, 100);  // Brief pause after move
        }
      }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

      // Load EEZ data
      const dataUrl = 'https://raw.githubusercontent.com/ayeeff/fiefdom/main/eez_v12_simplified.json';
      let dataLoaded = false;

      try {
        debug.innerHTML = `Fetching: ${dataUrl.substring(0, 50)}...`;
        loading.innerHTML = `
          <div class="loading-icon">üåç</div>
          <div>Downloading EEZ data...</div>
          <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">
            This may take 10-30 seconds (6MB file)
          </div>
        `;
        
        const response = await fetch(dataUrl);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        loading.innerHTML = `
          <div class="loading-icon">‚öôÔ∏è</div>
          <div>Processing data...</div>
          <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">
            Parsing GeoJSON...
          </div>
        `;
        
        const data = await response.json();
        debug.innerHTML = `Loaded ${data.features?.length || 0} features`;

        // Filter to polygons only
        let eezFeatures = data.features.filter(f => 
          f.geometry && 
          (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon')
        );
        
        console.log(`Filtered to ${eezFeatures.length} polygon features`);
        debug.innerHTML = `Processing ${eezFeatures.length} polygon features...`;

        if (eezFeatures.length > 0) {
          loading.innerHTML = `
            <div class="loading-icon">üé®</div>
            <div>Rendering globe...</div>
            <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">
              Drawing ${eezFeatures.length} EEZ zones
            </div>
          `;
          
          // Create a data source for EEZs
          const eezDataSource = new Cesium.GeoJsonDataSource('EEZs');
          await viewer.dataSources.add(eezDataSource);

          // Load GeoJSON into data source (pass full data, not filtered features)
          await eezDataSource.load(data, {
            clampToGround: false,
            stroke: Cesium.Color.BLUE.withAlpha(0.7),
            strokeWidth: 1.0,
            fill: true,
            markerSymbol: '?',
            entityCollection: new Cesium.EntityCollection()
          });

          // Style each entity
          const entities = eezDataSource.entities.values;
          entities.forEach((entity) => {  // Removed index param if unused
            if (entity.polygon) {
              const country = entity.properties.SOVEREIGN1?._value || 
                             entity.properties.TERRITORY1?._value || 
                             entity.properties.GEONAME?._value ||
                             entity.properties.SOVEREIGNT?._value || 
                             entity.properties.ADMIN?._value || 
                             entity.properties.name?._value ||
                             entity.properties.NAME?._value ||
                             'Unknown';
              
              const area = entity.properties.AREA_KM2?._value || entity.properties.area_km2?._value || '';
              
              // Set fill color
              entity.polygon.material = getCountryColor(country);
              entity.polygon.outline = true;
              entity.polygon.outlineColor = Cesium.Color.WHITE.withAlpha(0.5);
              entity.polygon.outlineWidth = 1.0;
              
              // Add label (initially hidden)
              entity.label = {
                text: '',
                font: '14pt monospace',
                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                fillColor: Cesium.Color.WHITE,
                outlineColor: Cesium.Color.BLACK,
                outlineWidth: 2,
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                pixelOffset: new Cesium.Cartesian2(0, -10),
                show: false,
                scale: 0.8
              };
              
              // Set name for label
              entity.name = country;
              
              // Description for info box on select
              entity.description = `
                <div style="background: rgba(0,0,0,0.85); padding: 10px 12px; border-radius: 6px; color: white; font-family: sans-serif;">
                  <b style="font-size: 14px;">${country}</b><br/>
                  <span style="font-size: 12px; opacity: 0.9;">Exclusive Economic Zone</span>
                  ${area ? `<br/><span style="font-size: 11px; opacity: 0.7;">Area: ${Math.round(area).toLocaleString()} km¬≤</span>` : ''}
                </div>
              `;
            }
          });

          // Global hover handler (updated to use entity.name)
          let highlightedEntity = null;
          handler.setInputAction((movement) => {
            const pickedFeature = viewer.scene.pick(movement.endPosition);
            if (Cesium.defined(pickedFeature) && pickedFeature.id && pickedFeature.id.polygon) {
              const entity = pickedFeature.id;
              if (entity !== highlightedEntity) {
                if (Cesium.defined(highlightedEntity)) {
                  highlightedEntity.label.show = false;
                }
                entity.label.show = true;
                entity.label.text = entity.name || 'EEZ Zone';
                highlightedEntity = entity;
                viewer.selectedEntity = entity;
                isInteracting = true;  // Pause rotation on hover
                setTimeout(() => { if (highlightedEntity === entity) isInteracting = false; }, 2000);
              }
            } else {
              if (Cesium.defined(highlightedEntity)) {
                highlightedEntity.label.show = false;
                highlightedEntity = null;
                viewer.selectedEntity = undefined;
                isInteracting = false;
              }
            }
          }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

          dataLoaded = true;
          loading.classList.add('hidden');
          debug.innerHTML = `‚úì Rendered ${entities.length} EEZ zones with Cesium.js`;
          
          // Hide debug after 5 seconds
          setTimeout(() => debug.classList.add('hidden'), 5000);
        }
      } catch (error) {
        console.error('Error loading EEZ data:', error);
        debug.innerHTML = `Error: ${error.message}`;
        loading.innerHTML = `
          <div style="max-width: 500px;">
            <div style="font-size: 40px; margin-bottom: 15px;">‚ö†Ô∏è</div>
            <div style="font-size: 18px; margin-bottom: 15px;">Unable to Load Real EEZ Data</div>
            <div style="font-size: 14px; line-height: 1.6; opacity: 0.9;">
              <p style="margin: 10px 0;">Check console for details. Ensure the GeoJSON URL is accessible.</p>
              <p style="margin: 15px 0 5px 0; font-size: 12px; opacity: 0.7;">
                Cesium.js is more performant, but large datasets may still need simplification.
              </p>
            </div>
          </div>
        `;
      }

      // Handle window resize
      window.addEventListener('resize', function() {
        viewer.resize();
      });
    });
  </script>
</body>
</html>
