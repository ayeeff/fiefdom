<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Nuclear Umbrella - SSBN Patrol Routes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        .orbitron { font-family: 'Orbitron', monospace; }
        .speed-card { background: linear-gradient(to bottom right, rgba(31, 41, 55, 0.8), rgba(15, 23, 42, 0.8)); backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.2); }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .shimmer-text { background: linear-gradient(90deg, transparent, #ff6b6b, transparent); background-size: 200% 100%; animation: shimmer 2s linear infinite; }
        #globeViz { width: 100%; height: 800px; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        #globeViz canvas { max-width: 100%; max-height: 100%; }
        .filter-btn { transition: all 0.2s; }
        .filter-btn.active { background: linear-gradient(to right, #dc2626, #f97316); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-red-950 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto p-4">
        <div class="mb-6 speed-card p-6 rounded-xl">
            <h1 class="text-4xl md:text-6xl font-black mb-4 text-center orbitron bg-gradient-to-r from-red-400 via-orange-400 to-yellow-400 bg-clip-text text-transparent shimmer-text">
                Nuclear SSBN Patrol Network - Scenarios
            </h1>
            <p class="text-center text-gray-300 text-sm mb-4">Ohio-class submarine patrol circuits and nuclear umbrella coverage zones</p>
            <div class="flex flex-wrap justify-center gap-2">
                <button onclick="switchScenario('current')" class="filter-btn active px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="tab-current">Current Patrols</button>
                <button onclick="switchScenario('2034')" class="filter-btn px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="tab-2034">2034: 30% US Reduction</button>
                <button onclick="switchScenario('2040')" class="filter-btn px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="tab-2040">2040: 60% US Reduction</button>
            </div>
        </div>

        <div class="mb-6 speed-card p-6 rounded-xl">
            <p class="text-center text-gray-300 text-sm mb-4">Sections: All Coverage | Pacific Theater | Atlantic Theater | Umbrella Zones</p>
            <div class="flex flex-wrap justify-center gap-2">
                <button onclick="filterView('all')" class="filter-btn active px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="btn-all">All Coverage</button>
                <button onclick="filterView('pacific')" class="filter-btn px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="btn-pacific">Pacific Theater</button>
                <button onclick="filterView('atlantic')" class="filter-btn px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="btn-atlantic">Atlantic Theater</button>
                <button onclick="filterView('umbrellas')" class="filter-btn px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="btn-umbrellas">Umbrella Zones</button>
            </div>
        </div>

        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-500"></div>
            <p class="mt-4 text-gray-400">Loading SSBN patrol data...</p>
        </div>

        <div id="mainContent" class="hidden">
            <div class="mb-6 speed-card p-6 rounded-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold orbitron text-red-400">Strategic Deterrence Network</h2>
                    <div class="text-sm text-gray-400"><span id="patrolInfo">Visualizing SSBN patrol circuits and coverage zones</span></div>
                </div>
                <div id="globeViz"></div>
            </div>

            <!-- Legend, Dashboard, Deployments, Implications (unchanged) -->
            <!-- ... (keeping your existing content for brevity) ... -->
        </div>
    </div>

    <script>
        let nuclearData = [], rawNuclearData = [], globe = null, currentView = 'all', currentScenario = 'current', countriesGeoData;

        // === UMBRELLA ZONES (Australia/NZ flip in 2040) ===
        const baseUmbrellaZones = {
            us: ['United States of America', 'Canada', 'Mexico', 'United Kingdom', 'France', 'Germany', 'Italy', 'Spain', 'Poland', 'Netherlands', 'Belgium', 'Portugal', 'Czech Republic', 'Greece', 'Hungary', 'Sweden', 'Austria', 'Switzerland', 'Denmark', 'Finland', 'Slovakia', 'Norway', 'Ireland', 'Croatia', 'Luxembourg', 'Slovenia', 'Lithuania', 'Latvia', 'Estonia', 'Romania', 'Bulgaria', 'Japan', 'South Korea', 'Philippines', 'Thailand', 'Singapore', 'Taiwan'],
            sinoRussian: ['Russia', 'China', 'North Korea', 'Belarus', 'Kazakhstan', 'Kyrgyzstan', 'Tajikistan', 'Uzbekistan', 'Turkmenistan', 'Mongolia', 'Laos', 'Cambodia', 'Myanmar', 'Iran', 'Venezuela', 'Cuba', 'Nicaragua'],
            saudiPakistan: ['Saudi Arabia', 'United Arab Emirates', 'Jordan', 'Egypt', 'Iraq', 'Kuwait', 'Bahrain', 'Qatar', 'Pakistan'],
            israel: ['Israel'],
            india: ['India', 'Bhutan']
        };

        function getUmbrellaZones() {
            const zones = JSON.parse(JSON.stringify(baseUmbrellaZones));
            if (currentScenario === '2040') {
                zones.sinoRussian.push('Australia', 'New Zealand');
                zones.us = zones.us.filter(c => !['Australia', 'New Zealand'].includes(c));
            }
            return zones;
        }

        function getCountryUmbrella(countryName) {
            const z = getUmbrellaZones();
            if (z.us.includes(countryName)) return { color: 'rgba(59, 130, 246, 0.6)', name: 'U.S. Umbrella' };
            if (z.sinoRussian.includes(countryName)) return { color: 'rgba(22, 163, 74, 0.6)', name: 'Sino-Russian Bloc' };
            if (z.saudiPakistan.includes(countryName)) return { color: 'rgba(6, 182, 212, 0.6)', name: 'Saudi-Pakistan Umbrella' };
            if (z.israel.includes(countryName)) return { color: 'rgba(229, 231, 235, 0.6)', name: 'Israeli Arsenal' };
            if (z.india.includes(countryName)) return { color: 'rgba(180, 83, 9, 0.6)', name: 'Indian Arsenal' };
            return { color: 'rgba(30, 41, 55, 0.4)', name: 'Neutral' };
        }

        // === DESTROY OLD GLOBE + CREATE NEW ONE (THE FIX) ===
        function destroyGlobe() {
            if (globe) {
                try { globe._destroy?.(); } catch(e) {}
                try {
                    const canvas = document.querySelector('#globeViz canvas');
                    if (canvas) {
                        const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
                        if (gl) gl.getExtension('WEBGL_lose_context')?.loseContext();
                    }
                } catch(e) {}
                globe = null;
            }
            document.getElementById('globeViz').innerHTML = '';
        }

        function createGlobe() {
            destroyGlobe(); // guarantee clean start

            globe = Globe()
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
                .pointOfView({ lat: 20, lng: 130, altitude: 2.2 })
                .atmosphereColor('#ff6b6b')
                .atmosphereAltitude(0.15)
                (document.getElementById('globeViz'));

            setTimeout(() => globe.pointOfView({ lat: 20, lng: 130, altitude: 2.2 }), 100);
        }

        // === YOUR ORIGINAL DATA + LOGIC (unchanged except calling refreshGlobe) ===
        // ... (patrolCircuitsCurrent, baseLocations, etc. – paste your full data here) ...

        async function loadData() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/topojson-client@3';
            script.onload = async () => {
                const geo = await fetch('https://unpkg.com/world-atlas/countries-110m.json').then(r => r.json());
                countriesGeoData = topojson.feature(geo, geo.objects.countries).features;

                const csv = await fetch('https://cdn.jsdelivr.net/gh/ayeeff/fiefdom@latest/data/nukes.csv').then(r => r.text());
                Papa.parse(csv, {
                    header: true, skipEmptyLines: true, dynamicTyping: true,
                    complete: r => { rawNuclearData = r.data; updateScenarioData(); refreshGlobe(); renderDashboard(); renderImplications(); }
                });
            };
            document.head.appendChild(script);
        }

        function refreshGlobe() {
            createGlobe();
            updateGlobeData(); // separate function that only sets paths/polygons etc.
        }

        function updateGlobeData() {
            if (!globe) return;

            const circuits = getPatrolCircuits();
            const paths = [];
            // ... your full path-building logic here (same as before) ...

            globe
                .pathsData(paths.filter(p => currentView === 'umbrellas' ? false : true))
                .pathPoints('coords')
                .pathPointLat(p => p[0])
                .pathPointLng(p => p[1])
                .pathColor('color')
                .pathLabel('label')
                .pathStroke(2)
                .pathDashLength(0.3)
                .pathDashGap(0.1)
                .pathDashAnimateTime(6000)
                .polygonsData(countriesGeoData)
                .polygonCapColor(f => getCountryUmbrella(f.properties.name).color)
                .polygonSideColor(() => 'rgba(0,0,0,0.1)')
                .polygonStrokeColor(() => '#111')
                .polygonLabel(f => `<b>${f.properties.name}</b><br>${getCountryUmbrella(f.properties.name).name}`);
        }

        function switchScenario(s) {
            currentScenario = s;
            document.querySelectorAll('[id^="tab-"]').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${s}`).classList.add('active');
            updateScenarioData();
            renderDashboard();
            refreshGlobe();           // ← This guarantees no context leak
            renderImplications();
        }

        function filterView(v) {
           215            currentView = v;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${v}`).classList.add('active');
            refreshGlobe();           // ← Also safe here
        }

        // Cleanup on page unload (extra safety)
        window.addEventListener('beforeunload', () => destroyGlobe());

        // Start loading
        loadData();
    </script>
</body>
</html>
