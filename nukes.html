<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Nuclear Umbrella - 3D Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        .orbitron { font-family: 'Orbitron', monospace; }
        .speed-card {
            background: linear-gradient(to bottom right, rgba(31, 41, 55, 0.8), rgba(15, 23, 42, 0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .shimmer-text {
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }
        #globeViz {
            width: 100%;
            height: 700px;
        }
        .filter-btn {
            transition: all 0.2s;
        }
        .filter-btn.active {
            background: linear-gradient(to right, #dc2626, #f97316);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-red-950 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="mb-6 speed-card p-6 rounded-xl">
            <h1 class="text-4xl md:text-6xl font-black mb-4 text-center orbitron bg-gradient-to-r from-red-400 via-orange-400 to-yellow-400 bg-clip-text text-transparent shimmer-text">
                Global Nuclear Umbrella
            </h1>
            <p class="text-center text-gray-300 text-sm mb-4">
                3D visualization of nuclear deterrence networks protecting allied nations
            </p>
            
            <!-- Filter Controls -->
            <div class="flex flex-wrap justify-center gap-2">
                <button onclick="filterRegion('all')" class="filter-btn active px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="btn-all">
                    üåç All Umbrellas
                </button>
                <button onclick="filterRegion('Asia')" class="filter-btn px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="btn-Asia">
                    üåè Asia-Pacific
                </button>
                <button onclick="filterRegion('Europe')" class="filter-btn px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="btn-Europe">
                    üá™üá∫ European Theater
                </button>
                <button onclick="filterRegion('Middle East')" class="filter-btn px-4 py-2 bg-slate-700 rounded-lg text-sm font-semibold" id="btn-Middle East">
                    üïå Middle East
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-500"></div>
            <p class="mt-4 text-gray-400">Loading nuclear umbrella data...</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <!-- 3D Globe -->
            <div class="mb-6 speed-card p-6 rounded-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold orbitron text-red-400">üõ°Ô∏è Nuclear Deterrence Network</h2>
                    <div class="text-sm text-gray-400">
                        <span id="activeArcs">0</span> active deterrence arcs
                    </div>
                </div>
                <div id="globeViz"></div>
            </div>

            <!-- Legend -->
            <div class="mb-6 speed-card p-6 rounded-xl">
                <h2 class="text-xl font-bold orbitron mb-4 text-orange-400">Legend</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full bg-red-500"></div>
                        <span class="text-sm">Nuclear Base</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                        <span class="text-sm">U.S. Extended Deterrence</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full bg-purple-500"></div>
                        <span class="text-sm">Local Deterrence</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full bg-green-500"></div>
                        <span class="text-sm">Protected Region</span>
                    </div>
                </div>
            </div>

            <!-- Regional Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="speed-card p-6 rounded-xl">
                    <div class="text-4xl mb-2">üåè</div>
                    <h3 class="text-xl font-bold text-blue-400 mb-2">Asia-Pacific</h3>
                    <div class="text-sm text-gray-400 mb-3">First Island Chain Defense</div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">U.S. Warheads:</span>
                            <span class="text-blue-400 font-bold" id="asia-us">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Regional Powers:</span>
                            <span class="text-purple-400 font-bold" id="asia-local">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Protected Nations:</span>
                            <span class="text-green-400 font-bold">7</span>
                        </div>
                    </div>
                </div>

                <div class="speed-card p-6 rounded-xl">
                    <div class="text-4xl mb-2">üá™üá∫</div>
                    <h3 class="text-xl font-bold text-purple-400 mb-2">European Theater</h3>
                    <div class="text-sm text-gray-400 mb-3">GIUK Gap & NATO Deterrence</div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">U.S. Warheads:</span>
                            <span class="text-blue-400 font-bold" id="europe-us">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">NATO Allies:</span>
                            <span class="text-purple-400 font-bold" id="europe-local">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Protected Nations:</span>
                            <span class="text-green-400 font-bold">10+</span>
                        </div>
                    </div>
                </div>

                <div class="speed-card p-6 rounded-xl">
                    <div class="text-4xl mb-2">üïå</div>
                    <h3 class="text-xl font-bold text-amber-400 mb-2">Middle East</h3>
                    <div class="text-sm text-gray-400 mb-3">Regional Stability</div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Israeli Arsenal:</span>
                            <span class="text-purple-400 font-bold" id="me-local">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Protected Nations:</span>
                            <span class="text-green-400 font-bold">5</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deployment Details -->
            <div class="mb-6 speed-card p-6 rounded-xl">
                <h2 class="text-2xl font-bold orbitron mb-4 text-yellow-400">Deployment Details</h2>
                <div id="deploymentsGrid" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        let nuclearData = [];
        let globe;
        let currentFilter = 'all';

        // Base locations (approximate coordinates)
        const baseLocations = {
            'Bangor, Washington': { lat: 47.7267, lng: -122.7113, country: 'USA' },
            'Kings Bay, Georgia': { lat: 30.7969, lng: -81.5526, country: 'USA' },
            'Kirtland, New Mexico': { lat: 35.0402, lng: -106.6088, country: 'USA' },
            'Kamchatka, Kamchatka Krai': { lat: 53.0123, lng: 158.6486, country: 'Russia' },
            'Gadzhiyevo, Murmansk Oblast': { lat: 69.2553, lng: 33.3250, country: 'Russia' },
            'Kozelsk, Kaluga Oblast': { lat: 54.0429, lng: 35.7844, country: 'Russia' },
            'Kaliningrad, Kaliningrad Oblast': { lat: 54.7104, lng: 20.4522, country: 'Russia' },
            'Faslane, Argyll and Bute': { lat: 56.0719, lng: -4.8155, country: 'UK' },
            'Coulport, Argyll and Bute': { lat: 56.0719, lng: -4.8155, country: 'UK' },
            '√éle Longue, Finist√®re': { lat: 48.3397, lng: -4.5500, country: 'France' },
            'Saint-Dizier, Haute-Marne': { lat: 48.6364, lng: 4.9497, country: 'France' },
            'Istres, Bouches-du-Rh√¥ne': { lat: 43.5127, lng: 4.9875, country: 'France' },
            'Yalong Bay, Hainan': { lat: 18.2383, lng: 109.5144, country: 'China' },
            'Hami, Xinjiang; Yumen, Gansu': { lat: 42.8453, lng: 93.5151, country: 'China' },
            'Yongbyon, North Pyongan; Pyongyang, Pyongyang': { lat: 39.7964, lng: 125.7539, country: 'North Korea' },
            'Mumbai, Maharashtra; Visakhapatnam, Andhra Pradesh': { lat: 19.0760, lng: 72.8777, country: 'India' },
            'Khushab, Punjab; Masroor, Sindh': { lat: 32.3000, lng: 72.3500, country: 'Pakistan' },
            'Dimona, Southern District; Tel-Nof, Central District': { lat: 31.0000, lng: 35.0333, country: 'Israel' },
            'Aviano, Friuli-Venezia Giulia': { lat: 46.0319, lng: 12.5965, country: 'Italy' },
            'B√ºchel, Rhineland-Palatinate': { lat: 50.1736, lng: 7.0633, country: 'Germany' },
            'Incirlik, Adana': { lat: 37.0000, lng: 35.4250, country: 'Turkey' },
            'Kleine Brogel, Limburg': { lat: 51.1667, lng: 5.4667, country: 'Belgium' },
            'Volkel, North Brabant': { lat: 51.6583, lng: 5.7083, country: 'Netherlands' }
        };

        // Protected regions (targets of deterrence)
        const protectedRegions = {
            'Asia': [
                { name: 'Japan', lat: 36.2048, lng: 138.2529 },
                { name: 'South Korea', lat: 35.9078, lng: 127.7669 },
                { name: 'Taiwan', lat: 23.6978, lng: 120.9605 },
                { name: 'Philippines', lat: 12.8797, lng: 121.7740 },
                { name: 'Australia', lat: -25.2744, lng: 133.7751 },
                { name: 'Thailand', lat: 15.8700, lng: 100.9925 },
                { name: 'Singapore', lat: 1.3521, lng: 103.8198 }
            ],
            'Europe': [
                { name: 'Poland', lat: 51.9194, lng: 19.1451 },
                { name: 'Germany', lat: 51.1657, lng: 10.4515 },
                { name: 'Baltic States', lat: 56.8796, lng: 24.6032 },
                { name: 'Norway', lat: 60.4720, lng: 8.4689 },
                { name: 'Romania', lat: 45.9432, lng: 24.9668 },
                { name: 'Italy', lat: 41.8719, lng: 12.5674 },
                { name: 'Spain', lat: 40.4637, lng: -3.7492 },
                { name: 'UK', lat: 55.3781, lng: -3.4360 },
                { name: 'France', lat: 46.2276, lng: 2.2137 },
                { name: 'Belgium', lat: 50.5039, lng: 4.4699 }
            ],
            'Middle East': [
                { name: 'Saudi Arabia', lat: 23.8859, lng: 45.0792 },
                { name: 'UAE', lat: 23.4241, lng: 53.8478 },
                { name: 'Jordan', lat: 30.5852, lng: 36.2384 },
                { name: 'Egypt', lat: 26.8206, lng: 30.8025 },
                { name: 'Iraq', lat: 33.2232, lng: 43.6793 }
            ]
        };

        async function loadData() {
            try {
                const response = await fetch('https://cdn.jsdelivr.net/gh/ayeeff/fiefdom@latest/data/nukes.csv');
                const csvText = await response.text();
               
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        nuclearData = results.data;
                        processData();
                        initGlobe();
                        renderDashboard();
                    }
                });
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = '<p class="text-red-400">Error loading data. Please try again.</p>';
            }
        }

        function parseNumber(val) {
            if (val === null || val === undefined || val === '‚Äî' || val === '') return 0;
            if (typeof val === 'number') return val;
            const str = String(val).replace(/[~,]/g, '').trim();
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        function processData() {
            // Process nuclear data
            nuclearData.forEach(row => {
                row.parsedStockpile = parseNumber(row['Total Stockpile']);
                row.parsedDeployed = parseNumber(row['Deployed Warheads']);
                row.parsedStrategic = parseNumber(row['Strategic Nukes']);
                row.parsedTactical = parseNumber(row['Tactical Nukes']);
            });
        }

        function initGlobe() {
            const world = Globe()
                (document.getElementById('globeViz'))
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
                .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
                .pointOfView({ lat: 30, lng: 0, altitude: 2.5 })
                .atmosphereColor('#ff6b6b')
                .atmosphereAltitude(0.15);

            globe = world;
            updateGlobe();
        }

        function updateGlobe() {
            const points = [];
            const arcs = [];

            nuclearData.forEach(row => {
                const region = row.Region;
                const base = row['Home Base'];
                const country = (row['Country / leg'] || '').split('‚Äì')[0].trim();
                
                if (currentFilter !== 'all' && region !== currentFilter) return;
                
                const baseCoords = baseLocations[base];
                if (!baseCoords) return;

                // Add base point
                points.push({
                    lat: baseCoords.lat,
                    lng: baseCoords.lng,
                    size: Math.sqrt(row.parsedStockpile) / 20,
                    color: country === 'USA' ? '#3b82f6' : 
                           ['Russia', 'China', 'North Korea'].includes(country) ? '#ef4444' :
                           '#a855f7',
                    label: `${row['Country / leg']}\n${row.parsedStockpile} warheads\n${base}`
                });

                // Add protection arcs
                const protected = protectedRegions[region] || [];
                protected.forEach(target => {
                    arcs.push({
                        startLat: baseCoords.lat,
                        startLng: baseCoords.lng,
                        endLat: target.lat,
                        endLng: target.lng,
                        color: country === 'USA' ? ['rgba(59, 130, 246, 0.4)', 'rgba(59, 130, 246, 0.8)'] :
                               ['rgba(168, 85, 247, 0.4)', 'rgba(168, 85, 247, 0.8)'],
                        label: `${row['Country / leg']} ‚Üí ${target.name}`
                    });

                    // Add protected region point
                    if (!points.find(p => p.lat === target.lat && p.lng === target.lng)) {
                        points.push({
                            lat: target.lat,
                            lng: target.lng,
                            size: 0.3,
                            color: '#22c55e',
                            label: `${target.name}\nProtected by nuclear umbrella`
                        });
                    }
                });
            });

            globe
                .pointsData(points)
                .pointAltitude('size')
                .pointColor('color')
                .pointLabel('label')
                .pointRadius(0.5)
                .arcsData(arcs)
                .arcColor('color')
                .arcDashLength(0.4)
                .arcDashGap(0.2)
                .arcDashAnimateTime(3000)
                .arcStroke(0.5)
                .arcLabel('label');

            document.getElementById('activeArcs').textContent = arcs.length;
        }

        function filterRegion(region) {
            currentFilter = region;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${region}`).classList.add('active');
            
            updateGlobe();
        }

        function renderDashboard() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');

            // Calculate regional stats
            const asiaUS = nuclearData.filter(r => r.Region === 'Asia' && r['Country / leg'].includes('USA'))
                .reduce((sum, r) => sum + r.parsedStockpile, 0);
            const asiaLocal = nuclearData.filter(r => r.Region === 'Asia' && !r['Country / leg'].includes('USA'))
                .reduce((sum, r) => sum + r.parsedStockpile, 0);
            
            const europeUS = nuclearData.filter(r => r.Region === 'Europe' && r['Country / leg'].includes('USA'))
                .reduce((sum, r) => sum + r.parsedStockpile, 0);
            const europeLocal = nuclearData.filter(r => r.Region === 'Europe' && !r['Country / leg'].includes('USA'))
                .reduce((sum, r) => sum + r.parsedStockpile, 0);
            
            const meLocal = nuclearData.filter(r => r.Region === 'Middle East')
                .reduce((sum, r) => sum + r.parsedStockpile, 0);

            document.getElementById('asia-us').textContent = asiaUS.toLocaleString();
            document.getElementById('asia-local').textContent = asiaLocal.toLocaleString();
            document.getElementById('europe-us').textContent = europeUS.toLocaleString();
            document.getElementById('europe-local').textContent = europeLocal.toLocaleString();
            document.getElementById('me-local').textContent = meLocal.toLocaleString();

            renderDeploymentsGrid();
        }

        function renderDeploymentsGrid() {
            const regions = ['Asia', 'Europe', 'Middle East'];
            const grid = document.getElementById('deploymentsGrid');
            
            grid.innerHTML = regions.map(region => {
                const entries = nuclearData.filter(r => r.Region === region);
                
                return `
                    <div class="bg-slate-800/50 border border-slate-600/30 rounded-xl p-4">
                        <h3 class="text-xl font-bold text-white mb-3">
                            ${region === 'Asia' ? 'üåè' : region === 'Europe' ? 'üá™üá∫' : 'üïå'} ${region}
                        </h3>
                        <div class="space-y-2">
                            ${entries.map(d => `
                                <div class="bg-slate-700/40 rounded-lg p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <div class="font-bold text-white">${d['Country / leg']}</div>
                                            <div class="text-xs text-gray-400">üìç ${d['Home Base']}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xl font-black text-red-400">${d.parsedStockpile.toLocaleString()}</div>
                                            <div class="text-xs text-gray-400">warheads</div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-400 italic border-l-2 border-slate-600 pl-2">${d['Notes']}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        loadData();
    </script>
</body>
</html>
